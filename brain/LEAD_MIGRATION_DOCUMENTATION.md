# Lead Migration & Duplicate Handling Documentation
*Last Updated: August 11, 2025*

## Overview
This document covers the complete lead migration system from LQF to The Brain, including duplicate detection, Vici synchronization, and CSV import capabilities.

## 1. Duplicate Lead Detection Strategy

### Time-Based Logic (Implemented in all lead ingestion points)
- **< 30 days**: Update existing lead record
  - Prevents multiple calls to same person
  - Updates lead with latest information
  - Preserves original `external_lead_id`

- **30-90 days**: Create re-engagement lead
  - Marks with `re_engagement: true` in metadata
  - Links to original lead via `original_lead_id`
  - Generates new `external_lead_id`
  - Tracks `days_since_original`

- **> 90 days**: Treat as new lead
  - No connection to old lead
  - Fresh opportunity after 3+ months
  - New `external_lead_id` generated

### Implementation Locations
1. **Main Webhook** (`/webhook.php` - Line 1818-1892)
2. **CSV Import Command** (`app/Console/Commands/ImportLQFCsv.php`)
3. **All other webhook endpoints** (to be implemented)

## 2. CSV Import System

### Command: `php artisan leads:import-csv`

#### Features:
- Parses LQF CSV format with nested JSON in `Data` column
- Extracts drivers, vehicles, and policy information
- Applies duplicate detection strategy
- Generates `external_lead_id` for new leads
- Optional Vici synchronization with `--update-vici` flag

#### Usage:
```bash
# Dry run (preview without changes)
php artisan leads:import-csv /path/to/file.csv --dry-run --limit=100

# Full import
php artisan leads:import-csv /path/to/file.csv

# Import with Vici update
php artisan leads:import-csv /path/to/file.csv --update-vici
```

#### CSV Structure Expected:
```
Id,Name,Phone,Email,State,Zip,Data,Created At
```
Where `Data` contains JSON with:
- `drivers`: Array of driver objects
- `vehicles`: Array of vehicle objects  
- `current_policy`: Current insurance information

## 3. Vici Integration

### ViciDial Database Configuration
- **Host**: 148.72.213.125
- **Port**: 3306
- **Database**: asterisk
- **User**: cron
- **Password**: 1234
- **Whitelist URL**: https://philli.callix.ai:26793/92RG8UJYTW.php

### Command: `php artisan vici:update-vendor-codes`

#### Features:
- Updates `vendor_lead_code` field in ViciDial
- Filters by campaigns (Auto2, Autodial)
- Matches leads by phone number
- Stores Vici `lead_id` back in Brain's meta field
- Dry-run mode for safety

#### Usage:
```bash
# Dry run
php artisan vici:update-vendor-codes --dry-run

# Update specific campaigns
php artisan vici:update-vendor-codes --campaigns=Auto2,Autodial

# Update specific phone
php artisan vici:update-vendor-codes --phone=2482205565
```

### Vici Non-Agent API (Backup Method)
If direct DB access fails, use Vici's API:
- **URL**: http://148.72.213.125/vicidial/non_agent_api.php
- **Function**: update_lead
- **Required**: source, user, pass, vendor_lead_code, search_method, search_location

## 4. Testing Endpoints

### `/test-vici-connection`
- **Methods**: GET, POST
- **CSRF**: Exempt
- **Actions**:
  - GET: Triggers whitelist and tests connection
  - POST with `action: check_vendor_codes`: Checks specific phone numbers

#### Example:
```bash
curl -X POST https://quotingfast-brain-ohio.onrender.com/test-vici-connection \
  -H "Content-Type: application/json" \
  -d '{"action": "check_vendor_codes", "phones": ["2482205565", "3133041372"]}'
```

## 5. External Lead ID Format

### Current Format: 13-digit timestamp
- Example: `1734367200000`
- Generated by: `Lead::generateExternalLeadId()`
- Stored in: `external_lead_id` field
- Used by: Vici as `vendor_lead_code`

### Legacy Format (being phased out)
- 9-digit starting with 10000001
- Still supported for backward compatibility

## 6. Docker Deployment Fixes

### Cumulative Learning Applied:
1. **ARG CACHEBUST**: Timestamp-based cache busting
2. **Single Layer Dependencies**: All packages in one RUN command
3. **Hardcoded PostgreSQL**: Direct .env configuration
4. **Simplified Startup**: Minimal startup script

### Dockerfile Location: `brain/Dockerfile.render`

## 7. Database Schema

### Leads Table Key Fields:
- `id`: Auto-increment primary key
- `external_lead_id`: Unique identifier for external systems
- `phone`: Used for duplicate detection
- `meta`: JSON field for additional data
- `created_at`: Used for age calculation in duplicate logic

## 8. Monitoring & Logs

### Log Entries to Watch:
- `üîç Duplicate lead detected` - Duplicate found
- `‚úÖ Updated existing lead` - Lead updated (< 30 days)
- `üîÑ Created re-engagement lead` - Re-engagement created (30-90 days)
- `üÜï Created new lead` - New lead after 90+ days
- `üî¢ Creating lead with generated external_lead_id` - ID generation

### Statistics Available:
- Total leads processed
- New leads created
- Updated leads
- Re-engagement leads
- Skipped/errors

## 9. Production Deployment Checklist

- [ ] Docker cache issues resolved with new Dockerfile
- [ ] CSRF exemptions in place for test endpoints
- [ ] Duplicate detection active on webhook
- [ ] CSV import command tested locally
- [ ] Vici whitelist URL triggered
- [ ] Vici update capability verified
- [ ] External lead ID generation confirmed

## 10. Troubleshooting

### Docker Build Failures
- Check `CACHEBUST` argument in Dockerfile
- Clear Render build cache if needed
- Verify all system dependencies listed

### Vici Connection Issues
1. Trigger whitelist URL first
2. Check firewall settings
3. Verify campaign names (case-sensitive)
4. Use API method if direct DB fails

### Duplicate Detection Not Working
- Check phone number format (digits only)
- Verify `created_at` timestamps
- Check logs for detection messages
- Ensure Lead model has proper date casting

## 11. Future Improvements

- [ ] Add duplicate detection to other webhook endpoints
- [ ] Implement bulk Vici update via API
- [ ] Add duplicate detection dashboard
- [ ] Create lead merge functionality
- [ ] Add configurable time windows for duplicate logic

---

*This documentation is part of the cumulative learning system. Update whenever changes are made.*
